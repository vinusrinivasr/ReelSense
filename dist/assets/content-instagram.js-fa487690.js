import"./register_all_kernels-d68f181a.js";import"./_commonjsHelpers-de833af9.js";let r=null,d=null,u=!1,R=null,m=null;const E={enabled:!0,mindlessThreshold:70,interventionType:"nudge",pauseDuration:60,genreFatigueLimit:15,scrollSpeedThreshold:5,minWatchTime:3,dailyLimit:120,showStats:!0};function C(s){var e;try{const n=s.src||s.currentSrc;if(n){const i=n.match(/\/([a-f0-9]{32})\./);if(i)return i[1];if(n.startsWith("blob:"))return"blob-"+n.slice(-12)}const t=s.closest("article");if(t){const i=(e=t.querySelector('a[href*="/reel/"]'))==null?void 0:e.href;if(i){const o=i.match(/\/reel\/([^/?]+)/);if(o)return o[1]}}return null}catch(n){return console.error("RS Insta: Error getting video ID from element:",n),null}}async function S(){if(console.log("RS Insta: Initializing script..."),d=await w(),(!d||Object.keys(d).length===0)&&(console.log("RS Insta: Waiting for settings..."),d=await new Promise(s=>setTimeout(async()=>s(await w()),500)),!d||Object.keys(d).length===0?(console.error("RS Insta: Failed to load settings. Using fallback."),d=E):console.log("RS Insta: Settings loaded:",d)),!d.enabled){console.log("RS Insta: Disabled via settings.");return}r=new q(d),console.log("RS Insta: Analyzer created."),p()?(console.log("RS Insta: Currently on Reels page, starting monitoring."),L()):console.log("RS Insta: Not currently on Reels page."),W()}function p(){return window.location.pathname.includes("/reels/")||window.location.pathname.startsWith("/reel/")}function w(){return new Promise(s=>{var e;if(!((e=chrome.runtime)!=null&&e.id)){console.log("RS Insta: Extension context not available yet for getSettings."),s({});return}chrome.runtime.sendMessage({action:"getSettings"},n=>{chrome.runtime.lastError?(console.error("RS Insta: Error getting settings:",chrome.runtime.lastError.message),s({})):s(n||{})})})}function L(){console.log("RS Insta: Starting monitoring event listeners."),window.addEventListener("wheel",s=>{u||(r&&r.recordScroll(),g(),v())},{passive:!0}),window.addEventListener("touchmove",s=>{u||(r&&r.recordScroll(),g(),v())},{passive:!0}),window.addEventListener("keydown",s=>{u||(s.key==="ArrowDown"||s.key==="ArrowUp")&&(r&&r.recordScroll(),g(),v())}),console.log("RS Insta: Performing initial video check on monitoring start."),g(),setInterval(()=>{u||(g(),A())},5e3)}function g(){const s=B(),e=D(),n=e?C(e):null,t=s||n;if(t&&t!==m){console.log(`RS Insta: New Video ID detected: ${t}`),m=t;const i=e?V(e):"unknown";console.log(`RS Insta: Detected Genre: ${i}`),r?r.recordVideoView(t,i):console.error("RS Insta: Analyzer not initialized!")}else!t&&m&&(console.log(`RS Insta: Navigated away from reel ${m}`),m=null)}function B(){const s=window.location.pathname.match(/\/(?:reels|reel)\/([^/?]+)/);return s?s[1]:null}function D(){try{const s=["article video[playsinline]",'div[role="dialog"] video',"main video[playsinline]","video[playsinline]"];let e=null,n=1/0;for(const t of s){const i=Array.from(document.querySelectorAll(t));for(const o of i){const a=o.getBoundingClientRect();if(a.bottom>50&&a.top<window.innerHeight-50&&a.height>100&&a.width>100){const h=Math.abs(a.top+a.height/2-window.innerHeight/2);h<n&&(n=h,e=o)}}if(e&&n<window.innerHeight/3)break}return e}catch(s){return console.error("RS Insta: Error finding video element:",s),null}}function V(s){try{let e=s==null?void 0:s.closest("article");if(e||(e=(s==null?void 0:s.closest('div[role="dialog"]'))||(s==null?void 0:s.closest("main > div > div"))),!e)return"unknown";const n=e.querySelector('h1, span[dir="auto"], div[role="caption"]');let t=((n==null?void 0:n.textContent)||e.textContent||"").toLowerCase();return e.querySelectorAll('a[href*="/explore/tags/"]').forEach(o=>{t+=" "+(o.textContent||"").replace("#","").toLowerCase()}),t.includes("comedy")||t.includes("funny")||t.includes("üòÇ")?"comedy":t.includes("dance")||t.includes("üíÉ")?"dance":t.includes("food")||t.includes("recipe")||t.includes("üçï")?"food":t.includes("fitness")||t.includes("workout")||t.includes("üí™")?"fitness":t.includes("travel")||t.includes("‚úàÔ∏è")?"travel":t.includes("fashion")||t.includes("style")||t.includes("üëó")?"fashion":t.includes("tech")||t.includes("gadget")?"tech":t.includes("animal")||t.includes("pet")||t.includes("üêï")?"animals":t.includes("music")||t.includes("üéµ")?"music":"general"}catch(e){return console.error("RS Insta: Error detecting genre:",e),"unknown"}}function v(){u||!r||r.shouldIntervene()}function k(s){var e;if(console.log("RS Insta: Triggering intervention:",s.reason),u=!0,r&&r.recordIntervention(),!((e=chrome.runtime)!=null&&e.id)){console.error("RS Insta: Cannot trigger intervention, runtime invalid.");return}chrome.runtime.sendMessage({action:"recordIntervention",platform:"instagram",type:s.reason},n=>{chrome.runtime.lastError&&console.error("RS Insta Err (recordIntervention):",chrome.runtime.lastError.message)}),chrome.runtime.sendMessage({action:"updateStats",platform:"instagram",data:{mindlessScore:s.score}},n=>{chrome.runtime.lastError&&console.error("RS Insta Err (updateScore):",chrome.runtime.lastError.message)}),d.interventionType==="block"?N(s):d.interventionType==="pause"?H(s):F(s)}function y(s){const e=document.createElement("div");return e.className="reelsense-feedback-wrapper",e.innerHTML=`
    <p class="reelsense-feedback-prompt">Was this a good time for a break?</p>
    <div class="reelsense-feedback-actions">
      <button class="reelsense-feedback-btn" data-label="1">üëç Yes</button>
      <button class="reelsense-feedback-btn" data-label="0">üëé No</button>
    </div>
  `,e.querySelectorAll(".reelsense-feedback-btn").forEach(n=>{n.addEventListener("click",()=>{var i;const t=parseInt(n.dataset.label,10);console.log("RS Insta: Sending feedback - Label:",t,"Features:",s),(i=chrome.runtime)!=null&&i.id?chrome.runtime.sendMessage({action:"logTrainingData",features:s,label:t},o=>{chrome.runtime.lastError?console.error("RS Insta Err (logTrainingData):",chrome.runtime.lastError.message):console.log("RS Insta: Feedback message sent successfully.")}):console.error("RS Insta: Cannot send feedback, runtime invalid."),e.innerHTML='<p class="reelsense-feedback-thanks">Thanks!</p>'})}),e}function F(s){var l;console.log("RS Insta: Showing Nudge");const e=f("nudge"),n={mindless_score:["You're scrolling on autopilot. Time to reset?"],genre_fatigue:[`Watched ${((l=s.details)==null?void 0:l.count)||"?"} similar videos. Ready for something new?`],ai_model:["ReelSense AI noticed a mindless pattern. Time for a quick break?"]},t=n[s.reason]||n.mindless_score,i=t[Math.floor(Math.random()*t.length)],o=r?r.getStats():{videosWatched:"N/A",scrollSpeed:"N/A"};e.innerHTML=`
    <div class="reelsense-nudge">
      <div class="reelsense-icon">üåü</div>
      <h2>ReelSense Check-In</h2>
      <p class="reelsense-message">${i}</p>
      <div class="reelsense-stats">
        <div class="stat-item">
          <span class="stat-label">Mindfulness Score</span>
          <span class="stat-value">${100-(s.score||0)}%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Reels Scrolled</span> <span class="stat-value">${o.videosWatched}</span>
        </div>
      </div>
      <div class="reelsense-actions">
        <button class="reelsense-btn primary" id="reelsense-continue-mindful">Continue Mindfully</button>
        <button class="reelsense-btn secondary" id="reelsense-take-break">Take a Break</button>
      </div>
    </div>
  `;const a=e.querySelector(".reelsense-nudge");a&&s.details&&a.appendChild(y(s.details)),document.body.appendChild(e),document.body.classList.add("reelsense-active"),document.getElementById("reelsense-continue-mindful").addEventListener("click",()=>{console.log("RS Insta: Nudge - Continue clicked"),document.getElementById("reelsense-overlay")===e&&e.remove(),document.body.classList.remove("reelsense-active"),u=!1,r&&r.resetSession()}),document.getElementById("reelsense-take-break").addEventListener("click",()=>{console.log("RS Insta: Nudge - Take Break clicked"),document.getElementById("reelsense-overlay")===e&&e.remove(),$()})}function H(s){console.log("RS Insta: Showing Pause Screen");const e=f("pause"),n=d.pauseDuration||60;e.innerHTML=`
    <div class="reelsense-pause">
      <div class="reelsense-icon">‚è∏Ô∏è</div>
      <h2>Mindful Pause</h2>
      <p>Your attention deserves a break. Let's reset.</p>
      <div class="reelsense-timer" id="reelsense-timer">${n}</div>
      <p class="reelsense-hint">Stretch, breathe, or look at something 20 feet away.</p>
      <div class="reelsense-progress-bar">
        <div class="reelsense-progress" id="reelsense-progress" style="width: 0%;"></div>
      </div>
    </div>
  `;const t=e.querySelector(".reelsense-pause");t&&s.details&&t.appendChild(y(s.details)),document.body.appendChild(e),document.body.classList.add("reelsense-active");let i=n;const o=setInterval(()=>{i--;const a=document.getElementById("reelsense-timer"),l=document.getElementById("reelsense-progress");a&&(a.textContent=i),l&&(l.style.width=(n-i)/n*100+"%"),i<=0&&(clearInterval(o),console.log("RS Insta: Pause timer finished"),document.getElementById("reelsense-overlay")===e&&e.remove(),document.body.classList.remove("reelsense-active"),u=!1,r&&r.resetSession())},1e3)}function N(s){console.log("RS Insta: Showing Block Screen");const e=f("block"),n=r?r.getStats():{videosWatched:"N/A",sessionDuration:"N/A"};e.innerHTML=`
    <div class="reelsense-block">
      <div class="reelsense-icon">üõë</div>
      <h2>Content Blocked</h2>
      <p>You've reached your mindful scrolling limit for now.</p>
      <div class="reelsense-stats-grid">
        <div class="stat-box">
          <div class="stat-number">${n.videosWatched}</div>
          <div class="stat-desc">Reels Scrolled</div> </div>
        <div class="stat-box">
          <div class="stat-number">${n.sessionDuration}min</div>
          <div class="stat-desc">Session Time</div>
        </div>
      </div>
      <p class="reelsense-suggestion">Consider: Going for a walk, calling a friend, or doing something creative.</p>
      <button class="reelsense-btn primary" id="reelsense-end-session">End Session</button>
    </div>
  `;const t=e.querySelector(".reelsense-block");t&&s.details&&t.appendChild(y(s.details)),document.body.appendChild(e),document.body.classList.add("reelsense-active"),document.getElementById("reelsense-end-session").addEventListener("click",()=>{console.log("RS Insta: Block - End Session clicked"),window.location.href="https://www.instagram.com/"})}function $(){console.log("RS Insta: Showing Breathing Exercise");const s=f("breathing");s.innerHTML=`
    <div class="reelsense-breathing">
      <h2>Breathing Exercise</h2>
      <p>Follow the circle rhythm</p>
      <div class="breathing-circle" id="breathing-circle" style="transform: scale(1);"></div>
      <div class="breathing-text" id="breathing-text">Breathe In</div>
      <button class="reelsense-btn secondary" id="breathing-skip">Skip</button>
    </div>
  `,document.body.appendChild(s),document.body.classList.add("reelsense-active");const e=document.getElementById("breathing-circle"),n=document.getElementById("breathing-text");let t=0;const i=3;let o,a,l;function h(){clearTimeout(o),clearTimeout(a),clearTimeout(l),document.getElementById("reelsense-overlay")===s&&s.remove(),document.body.classList.remove("reelsense-active"),u=!1,r&&r.resetSession(),console.log("RS Insta: Breathing exercise ended/skipped")}function c(){if(!n||!e||!document.body.contains(s)){h();return}n.textContent="Breathe In",e.style.transform="scale(1.5)",e.style.transition="transform 4s ease-in-out",o=setTimeout(()=>{n&&(n.textContent="Hold"),a=setTimeout(()=>{n&&(n.textContent="Breathe Out"),e&&(e.style.transform="scale(1)"),l=setTimeout(()=>{t++,t<i?c():h()},2e3)},2e3)},4e3)}c(),document.getElementById("breathing-skip").addEventListener("click",h)}function f(s){const e=document.getElementById("reelsense-overlay");e&&(console.log("RS Insta: Removing existing overlay."),e.remove());const n=document.createElement("div");return n.className=`reelsense-overlay reelsense-${s}`,n.id="reelsense-overlay",n.style.zIndex="2147483647",n}function A(){var s;(s=chrome.runtime)!=null&&s.id&&chrome.runtime.sendMessage({action:"updateStats",platform:"instagram",data:{time:5}},e=>{chrome.runtime.lastError&&console.error("RS Insta Err (updateTime):",chrome.runtime.lastError.message)})}function W(){let s=location.href;console.log("RS Insta: Starting navigation observer. Initial URL:",s),R=new MutationObserver(()=>{window.requestAnimationFrame(()=>{const e=location.href;if(e!==s){const n=s;if(s=e,console.log(`RS Insta: URL changed via MutationObserver from ${n} to ${e}`),!u){const t=document.getElementById("reelsense-overlay");t&&t.remove(),document.body.classList.remove("reelsense-active")}p()?(console.log("RS Insta: Navigated within Reels context"),g(),r?r.resetSession():(console.log("RS Insta: Analyzer missing, re-initializing."),S())):(console.log("RS Insta: Navigated away from Reels"),m=null,r&&r.resetSession())}})}),R.observe(document.body,{subtree:!0,childList:!0}),window.addEventListener("popstate",()=>{console.log("RS Insta: Popstate event detected"),setTimeout(()=>{if(s=document.location.href,console.log("RS Insta: URL after popstate:",s),!u){const e=document.getElementById("reelsense-overlay");e&&e.remove(),document.body.classList.remove("reelsense-active")}g(),p()?r?r.resetSession():(console.log("RS Insta: Analyzer missing after popstate, re-initializing."),S()):r&&r.resetSession()},50)})}var T;(T=chrome.runtime)!=null&&T.onMessage?chrome.runtime.onMessage.addListener((s,e,n)=>{s.action==="TRIGGER_INTERVENTION"&&console.log("RS Insta: Intervention remotely triggered by background.js (Ignoring)")}):console.error("RS Insta: chrome.runtime.onMessage not available.");class q{constructor(e){this.settings=e||E,this.scrollEvents=[],this.videoHistory=[],this.genreSequence=[],this.sessionStartTime=Date.now(),this.currentVideoStartTime=null,this.currentVideoId=null,this.currentVideoGenre=null,this.lastScrollTime=0,this.scrollSpeed=0,this.avgWatchTime=0,this.skipRate=0,this.genreDiversity=1,this.mindlessScore=0,this.lastInterventionTime=0}recordScroll(){const e=Date.now();this.scrollEvents.push(e),this.scrollEvents=this.scrollEvents.filter(n=>e-n<1e4),this.scrollSpeed=this.scrollEvents.length/10,this.lastScrollTime=e,this.updateMindlessScore()}recordVideoView(e,n="unknown"){var i;console.log(`RS Insta: Recording view for videoId: ${e}`);const t=Date.now();if(this.currentVideoId&&this.currentVideoId!==e){const o=(t-this.currentVideoStartTime)/1e3;o>.5?(this.videoHistory.push({id:this.currentVideoId,watchTime:o,genre:this.currentVideoGenre,timestamp:this.currentVideoStartTime}),console.log(`RS Insta: Logged ${o.toFixed(1)}s for previous video ${this.currentVideoId}`),this.videoHistory.length>50&&this.videoHistory.shift()):console.log(`RS Insta: Ignoring very short view (${o.toFixed(1)}s)`)}if(this.currentVideoId!==e)console.log("RS Insta: Sending 'videos: 1' for NEW video:",e),(i=chrome.runtime)!=null&&i.id&&chrome.runtime.sendMessage({action:"updateStats",platform:"instagram",data:{videos:1}},o=>{chrome.runtime.lastError?console.error("RS Insta Err:",chrome.runtime.lastError.message):console.log("RS Insta: Video count updated successfully")});else{console.log(`RS Insta: Same video ${e} - no duplicate count`);return}this.currentVideoStartTime=t,this.currentVideoId=e,this.currentVideoGenre=n,this.genreSequence.push(n),this.genreSequence.length>30&&this.genreSequence.shift(),this.calculateMetrics(),this.updateMindlessScore(),console.log(`RS Insta: State updated. Score: ${this.mindlessScore}, Videos: ${this.videoHistory.length}`)}calculateMetrics(){var o;if(this.videoHistory.length===0){this.avgWatchTime=0,this.skipRate=0,this.genreDiversity=1;return}const e=this.videoHistory.reduce((a,l)=>a+l.watchTime,0);this.avgWatchTime=e/this.videoHistory.length;const n=((o=this.settings)==null?void 0:o.minWatchTime)||3,t=this.videoHistory.filter(a=>a.watchTime<n).length;this.skipRate=this.videoHistory.length>0?t/this.videoHistory.length:0;const i=this.genreSequence.slice(-20);if(i.length>0){const a=new Set(i.filter(l=>l&&l!=="unknown"&&l!=="general")).size;this.genreDiversity=i.length>0?a/i.length:1}else this.genreDiversity=1}detectGenreFatigue(){var h;const e=((h=this.settings)==null?void 0:h.genreFatigueLimit)||15;if(this.genreSequence.length<e)return{fatigued:!1};const n=this.genreSequence.slice(-e),t={};let i="unknown",o=0;n.forEach(c=>{c&&c!=="unknown"&&c!=="general"&&(t[c]=(t[c]||0)+1,t[c]>o&&(o=t[c],i=c))});const a=e*.7;return{fatigued:o>=a&&i!=="unknown",count:o,genre:i}}updateMindlessScore(){var I,b;let e=0;const n=((I=this.settings)==null?void 0:I.scrollSpeedThreshold)||5,t=((b=this.settings)==null?void 0:b.minWatchTime)||3,i=n>0?Math.min(2,this.scrollSpeed/n):this.scrollSpeed>0?2:0,o=Math.min(30,i*15);e+=o;const a=this.skipRate*25;e+=a;const l=this.avgWatchTime<t?20:Math.max(0,20*(1-this.avgWatchTime/(t*2))),h=Math.min(20,l);e+=h;const c=(1-this.genreDiversity)*15;e+=c;const M=(Date.now()-this.sessionStartTime)/6e4,x=Math.min(10,M/30*10);return e+=x,this.mindlessScore=Math.round(Math.max(0,Math.min(100,e))),console.log(`RS ScoreCalc: FINAL SCORE = ${this.mindlessScore}`),this.mindlessScore}getStatsAsFeatures(){const e={scrollSpeed:Number(this.scrollSpeed.toFixed(2))||0,avgWatchTime:Number(this.avgWatchTime.toFixed(1))||0,skipRate:Number(this.skipRate.toFixed(2))||0,genreDiversity:Number(this.genreDiversity.toFixed(2))||1,sessionMinutes:Math.round((Date.now()-this.sessionStartTime)/6e4)||0};for(const n in e)Number.isFinite(e[n])||(e[n]=0);return e}shouldIntervene(){var t;const e=Date.now();if((e-this.lastInterventionTime)/1e3<300)return{shouldIntervene:!1,reason:"too_soon"};this.calculateMetrics(),this.updateMindlessScore();const n=this.getStatsAsFeatures();return(t=chrome.runtime)!=null&&t.id?(chrome.runtime.sendMessage({action:"PREDICT_BEHAVIOR",features:n},i=>{if(u||!r||this.lastInterventionTime>e){console.log("RS Insta: State changed during prediction, ignoring response.");return}if(chrome.runtime.lastError){console.error("RS Insta: Error getting prediction:",chrome.runtime.lastError.message),this.checkHeuristicsAndTrigger(n);return}if(i!=null&&i.success&&typeof i.prediction=="number"){const o=i.prediction,a=.75;if(console.log(`RS Insta: AI Pred Received: ${o.toFixed(3)} (Thresh: ${a})`),o>a){console.log(`RS Insta: AI Trigger (Score: ${o.toFixed(2)})`),k({shouldIntervene:!0,reason:"ai_model",score:Math.round(o*100),details:n});return}else console.log("RS Insta: AI Score low. Checking heuristics.")}else console.log("RS Insta: Prediction failed/model not ready. Falling back.",i==null?void 0:i.error);this.checkHeuristicsAndTrigger(n)}),{shouldIntervene:!1,reason:"checking_async"}):(console.error("RS Insta: Runtime not available, falling back immediately."),this.checkHeuristics(n))}checkHeuristics(e){var i;this.updateMindlessScore();const n=((i=this.settings)==null?void 0:i.mindlessThreshold)||70,t=this.detectGenreFatigue();return console.log(`RS Heuristics CHECKING: Score=${this.mindlessScore}, Threshold=${n}, Fatigue:`,t),t.fatigued?(console.log(`RS Heuristic Trigger (Fatigue: ${t.genre} x${t.count})`),{shouldIntervene:!0,reason:"genre_fatigue",score:this.mindlessScore,details:{...e,genre:t.genre,count:t.count}}):this.mindlessScore>=n?(console.log(`RS Heuristic Trigger (Score: ${this.mindlessScore})`),{shouldIntervene:!0,reason:"mindless_score",score:this.mindlessScore,details:e}):{shouldIntervene:!1,reason:"none"}}checkHeuristicsAndTrigger(e){if((Date.now()-this.lastInterventionTime)/1e3<300){console.log("RS Insta: Cooldown active after async check.");return}const t=this.checkHeuristics(e);t.shouldIntervene?k(t):console.log("RS Insta: No intervention needed after checks.")}recordIntervention(){this.lastInterventionTime=Date.now()}getStats(){return this.calculateMetrics(),{mindlessScore:this.mindlessScore,scrollSpeed:this.scrollSpeed.toFixed(2),videosWatched:this.videoHistory.length+(this.currentVideoId?1:0),avgWatchTime:this.avgWatchTime.toFixed(1),skipRate:(this.skipRate*100).toFixed(0),genreDiversity:(this.genreDiversity*100).toFixed(0),sessionDuration:Math.round((Date.now()-this.sessionStartTime)/6e4)}}resetSession(){console.log("RS Insta: Resetting session state."),this.scrollEvents=[],this.videoHistory=[],this.genreSequence=[],this.sessionStartTime=Date.now(),this.currentVideoStartTime=null,this.currentVideoId=null,this.currentVideoGenre=null,this.mindlessScore=0,this.avgWatchTime=0,this.skipRate=0,this.genreDiversity=1}}S();
