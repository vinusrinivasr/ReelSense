import"./register_all_kernels-99d2b967.js";import"./_commonjsHelpers-de833af9.js";let o=null,d=null,u=!1,E=null,h=null;const $={enabled:!0,mindlessThreshold:70,interventionType:"nudge",pauseDuration:60,genreFatigueLimit:15,scrollSpeedThreshold:5,minWatchTime:3,dailyLimit:120,showStats:!0};async function f(){if(console.log("ReelSense: YouTube script loaded"),d=await R(),(!d||Object.keys(d).length===0)&&(console.log("ReelSense: Waiting for settings..."),d=await new Promise(s=>setTimeout(async()=>s(await R()),500)),(!d||Object.keys(d).length===0)&&(console.error("ReelSense: Failed to load settings. Using fallback."),d=$)),!d.enabled){console.log("ReelSense: Disabled");return}o=new A(d),S()&&F(),B()}function S(){return window.location.pathname.includes("/shorts/")}function R(){return new Promise(s=>{var t;if(!((t=chrome.runtime)!=null&&t.id)){console.log("ReelSense: Extension context not available yet for getSettings."),s({});return}chrome.runtime.sendMessage({action:"getSettings"},e=>{chrome.runtime.lastError?(console.log("ReelSense: Error getting settings:",chrome.runtime.lastError.message),s({})):s(e||{})})})}function F(){console.log("ReelSense: Starting YouTube Shorts monitoring via URL changes"),window.addEventListener("wheel",s=>{u||(o&&o.recordScroll(),g())},{passive:!0}),window.addEventListener("touchmove",s=>{u||(o&&o.recordScroll(),g())},{passive:!0}),window.addEventListener("keydown",s=>{u||(s.key==="ArrowDown"||s.key==="ArrowUp"||s.key==="k"||s.key===" ")&&(o&&o.recordScroll(),g())}),p(),setInterval(()=>{u||W()},5e3)}function p(){const s=C();if(s&&s!==h){console.log(`ReelSense: Video ID changed from ${h} to ${s}`),h=s;const t=I();o?o.recordVideoView(s,t):console.log("ReelSense: Analyzer not ready during checkVideoChange")}else if(!s&&h)console.log(`ReelSense: Navigated away from specific short ${h}`),h=null;else if(s&&s===h&&o&&o.currentVideoId!==s){const t=I();o.recordVideoView(s,t)}}function C(){const s=window.location.pathname.match(/\/shorts\/([^/?]+)/);return s?s[1]:null}function I(){try{const s=document.querySelector("h2.title yt-formatted-string, #title h2, #video-title"),t=document.querySelector("#description yt-formatted-string, #description .content");let e=(((s==null?void 0:s.textContent)||"")+" "+((t==null?void 0:t.textContent)||"")).toLowerCase();return document.querySelectorAll('a[href*="/hashtag/"]').forEach(i=>{e+=" "+(i.textContent||"").toLowerCase()}),e.includes("comedy")||e.includes("funny")||e.includes("meme")?"comedy":e.includes("music")||e.includes("song")||e.includes("cover")?"music":e.includes("game")||e.includes("gaming")||e.includes("gameplay")?"gaming":e.includes("cook")||e.includes("recipe")||e.includes("food")?"food":e.includes("workout")||e.includes("fitness")||e.includes("exercise")?"fitness":e.includes("tech")||e.includes("review")||e.includes("unbox")?"tech":e.includes("travel")||e.includes("vlog")?"travel":e.includes("tutorial")||e.includes("how to")||e.includes("learn")?"educational":e.includes("animal")||e.includes("pet")||e.includes("cat")||e.includes("dog")?"animals":e.includes("dance")||e.includes("choreography")?"dance":"general"}catch(s){return console.error("ReelSense: Error detecting genre:",s),"unknown"}}function g(){u||!o||o.shouldIntervene()}function x(s){var t;u=!0,o&&o.recordIntervention(),(t=chrome.runtime)!=null&&t.id&&(chrome.runtime.sendMessage({action:"recordIntervention",platform:"youtube",type:s.reason},e=>{chrome.runtime.lastError&&console.log("RS Err:",chrome.runtime.lastError.message)}),chrome.runtime.sendMessage({action:"updateStats",platform:"youtube",data:{mindlessScore:s.score}},e=>{chrome.runtime.lastError&&console.log("RS Err:",chrome.runtime.lastError.message)}),d.interventionType==="block"?V(s):d.interventionType==="pause"?D(s):L(s))}function y(s){const t=document.createElement("div");return t.className="reelsense-feedback-wrapper",t.innerHTML=`
    <p class="reelsense-feedback-prompt">Was this a good time for a break?</p>
    <div class="reelsense-feedback-actions">
      <button class="reelsense-feedback-btn" data-label="1">üëç Yes</button>
      <button class="reelsense-feedback-btn" data-label="0">üëé No</button>
    </div>
  `,t.querySelectorAll(".reelsense-feedback-btn").forEach(e=>{e.addEventListener("click",()=>{var i;const n=parseInt(e.dataset.label,10);(i=chrome.runtime)!=null&&i.id&&chrome.runtime.sendMessage({action:"logTrainingData",features:s,label:n},c=>{chrome.runtime.lastError&&console.log("RS Err:",chrome.runtime.lastError.message)}),t.innerHTML='<p class="reelsense-feedback-thanks">Thanks for the feedback!</p>'})}),t}function L(s){var l;const t=v("nudge"),e={mindless_score:["You're scrolling on autopilot. Time to reset?"],genre_fatigue:[`Watched ${((l=s.details)==null?void 0:l.count)||"?"} similar videos. Ready for something new?`],ai_model:["ReelSense AI noticed a mindless pattern. Time for a quick break?"]},n=e[s.reason]||e.mindless_score,i=n[Math.floor(Math.random()*n.length)],c=o?o.getStats():{videosWatched:"N/A"};t.innerHTML=`
    <div class="reelsense-nudge">
      <div class="reelsense-icon">üåü</div>
      <h2>ReelSense Check-In</h2>
      <p class="reelsense-message">${i}</p>
      <div class="reelsense-stats">
        <div class="stat-item">
          <span class="stat-label">Attention Score</span>
          <span class="stat-value">${100-(s.score||0)}%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Shorts Scrolled</span> <span class="stat-value">${c.videosWatched}</span>
        </div>
      </div>
      <div class="reelsense-actions">
        <button class="reelsense-btn primary" id="reelsense-continue-mindful">
          Continue Mindfully
        </button>
        <button class="reelsense-btn secondary" id="reelsense-take-break">
          Take a Break
        </button>
      </div>
    </div>
  `;const r=t.querySelector(".reelsense-nudge");r&&s.details&&r.appendChild(y(s.details)),document.body.appendChild(t),document.body.classList.add("reelsense-active"),document.getElementById("reelsense-continue-mindful").addEventListener("click",()=>{t.remove(),document.body.classList.remove("reelsense-active"),u=!1,o&&o.resetSession()}),document.getElementById("reelsense-take-break").addEventListener("click",()=>{t.remove(),H()})}function D(s){const t=v("pause"),e=d.pauseDuration||60;t.innerHTML=`
    <div class="reelsense-pause">
      <div class="reelsense-icon">‚è∏Ô∏è</div>
      <h2>Mindful Pause</h2>
      <p>Your attention deserves a break. Let's reset.</p>
      <div class="reelsense-timer" id="reelsense-timer">${e}</div>
      <p class="reelsense-hint">Stretch, breathe, or look at something 20 feet away.</p>
      <div class="reelsense-progress-bar">
        <div class="reelsense-progress" id="reelsense-progress" style="width: 0%;"></div>
      </div>
    </div>
  `;const n=t.querySelector(".reelsense-pause");n&&s.details&&n.appendChild(y(s.details)),document.body.appendChild(t),document.body.classList.add("reelsense-active");let i=e;const c=setInterval(()=>{i--;const r=document.getElementById("reelsense-timer"),l=document.getElementById("reelsense-progress");r&&(r.textContent=i),l&&(l.style.width=(e-i)/e*100+"%"),i<=0&&(clearInterval(c),document.getElementById("reelsense-overlay")===t&&t.remove(),document.body.classList.remove("reelsense-active"),u=!1,o&&o.resetSession())},1e3)}function V(s){const t=v("block"),e=o?o.getStats():{videosWatched:"N/A",sessionDuration:"N/A"};t.innerHTML=`
    <div class="reelsense-block">
      <div class="reelsense-icon">üõë</div>
      <h2>Shorts Blocked</h2>
      <p>You've reached your mindful limit for this session.</p>
      <div class="reelsense-stats-grid">
        <div class="stat-box">
          <div class="stat-number">${e.videosWatched}</div>
          <div class="stat-desc">Shorts Scrolled</div> </div>
        <div class="stat-box">
          <div class="stat-number">${e.sessionDuration}min</div>
          <div class="stat-desc">Time Spent</div>
        </div>
      </div>
      <p class="reelsense-suggestion">
        Try: Watch a long-form video, read comments, or explore subscriptions.
      </p>
      <button class="reelsense-btn primary" id="reelsense-end-session">
        Go to YouTube Home
      </button>
    </div>
  `;const n=t.querySelector(".reelsense-block");n&&s.details&&n.appendChild(y(s.details)),document.body.appendChild(t),document.body.classList.add("reelsense-active"),document.getElementById("reelsense-end-session").addEventListener("click",()=>{window.location.href="https://www.youtube.com/"})}function H(){const s=v("breathing");s.innerHTML=`
    <div class="reelsense-breathing">
      <h2>Breathing Exercise</h2>
      <p>Follow the circle rhythm</p>
      <div class="breathing-circle" id="breathing-circle" style="transform: scale(1);"></div>
      <div class="breathing-text" id="breathing-text">Breathe In</div>
      <button class="reelsense-btn secondary" id="breathing-skip">Skip</button>
    </div>
  `,document.body.appendChild(s),document.body.classList.add("reelsense-active");const t=document.getElementById("breathing-circle"),e=document.getElementById("breathing-text");let n=0;const i=3;let c,r,l;function a(){clearTimeout(c),clearTimeout(r),clearTimeout(l),document.getElementById("reelsense-overlay")===s&&s.remove(),document.body.classList.remove("reelsense-active"),u=!1,o&&o.resetSession()}function m(){if(!e||!t||!document.body.contains(s)){a();return}e.textContent="Breathe In",t.style.transform="scale(1.5)",t.style.transition="transform 4s ease-in-out",c=setTimeout(()=>{e&&(e.textContent="Hold"),r=setTimeout(()=>{e&&(e.textContent="Breathe Out"),t&&(t.style.transform="scale(1)"),l=setTimeout(()=>{n++,n<i?m():a()},2e3)},2e3)},4e3)}m(),document.getElementById("breathing-skip").addEventListener("click",a)}function v(s){const t=document.getElementById("reelsense-overlay");t&&t.remove();const e=document.createElement("div");return e.className=`reelsense-overlay reelsense-${s}`,e.id="reelsense-overlay",e.style.zIndex="2147483647",e}function W(){var s;(s=chrome.runtime)!=null&&s.id&&chrome.runtime.sendMessage({action:"updateStats",platform:"youtube",data:{time:5}},t=>{chrome.runtime.lastError&&console.log("RS Err:",chrome.runtime.lastError.message)})}function B(){let s=location.href;E=new MutationObserver(()=>{window.requestAnimationFrame(()=>{const t=location.href;if(t!==s){const e=s;s=t,console.log(`ReelSense: URL changed from ${e} to ${t}`);const n=document.getElementById("reelsense-overlay");n&&n.remove(),document.body.classList.remove("reelsense-active"),S()?(console.log("ReelSense: Navigated within Shorts context"),p(),o?o.resetSession():f()):(console.log("ReelSense: Navigated away from Shorts"),h=null,o&&o.resetSession())}})}),E.observe(document.body,{subtree:!0,childList:!0}),window.addEventListener("popstate",()=>{console.log("ReelSense: Popstate event detected"),setTimeout(()=>{s=document.location.href,p(),S()?o?o.resetSession():f():o&&o.resetSession()},50)})}var M;(M=chrome.runtime)!=null&&M.onMessage?chrome.runtime.onMessage.addListener((s,t,e)=>{s.action==="TRIGGER_INTERVENTION"&&console.log("Intervention remotely triggered by background.js")}):console.log("ReelSense: chrome.runtime.onMessage not available.");class A{constructor(t){this.settings=t||$,this.scrollEvents=[],this.videoHistory=[],this.genreSequence=[],this.sessionStartTime=Date.now(),this.currentVideoStartTime=null,this.currentVideoId=null,this.currentVideoGenre=null,this.lastScrollTime=0,this.scrollSpeed=0,this.avgWatchTime=0,this.skipRate=0,this.genreDiversity=1,this.mindlessScore=0,this.lastInterventionTime=0}recordScroll(){const t=Date.now();this.scrollEvents.push(t),this.scrollEvents=this.scrollEvents.filter(e=>t-e<1e4),this.scrollSpeed=this.scrollEvents.length/10,this.lastScrollTime=t,this.updateMindlessScore()}recordVideoView(t,e="unknown"){var i,c;console.log(`ReelSense: Recording view for videoId: ${t}`);const n=Date.now();if(this.currentVideoStartTime&&this.currentVideoId){const r=(n-this.currentVideoStartTime)/1e3;r>.1?(this.videoHistory.push({id:this.currentVideoId,watchTime:r,genre:this.currentVideoGenre,timestamp:this.currentVideoStartTime}),console.log(`ReelSense: Logged watchTime ${r.toFixed(1)}s for previous video ${this.currentVideoId}`),this.videoHistory.length>50&&this.videoHistory.shift(),(i=chrome.runtime)!=null&&i.id&&chrome.runtime.sendMessage({action:"updateStats",platform:"youtube",data:{videos:1}},l=>{chrome.runtime.lastError&&console.log("RS Err:",chrome.runtime.lastError.message)})):console.log(`ReelSense: Ignoring very short view (${r.toFixed(1)}s) for ${this.currentVideoId}`)}else console.log(`ReelSense: First video recorded: ${t}`),t&&((c=chrome.runtime)!=null&&c.id)&&chrome.runtime.sendMessage({action:"updateStats",platform:"youtube",data:{videos:1}},r=>{chrome.runtime.lastError&&console.log("RS Err:",chrome.runtime.lastError.message)});this.currentVideoStartTime=n,this.currentVideoId=t,this.currentVideoGenre=e,this.genreSequence.push(e),this.genreSequence.length>30&&this.genreSequence.shift(),this.calculateMetrics(),this.updateMindlessScore(),console.log(`ReelSense: State updated for ${t}. Score: ${this.mindlessScore}, Avg Watch: ${this.avgWatchTime.toFixed(1)}s`)}calculateMetrics(){var c;if(this.videoHistory.length===0){this.avgWatchTime=0,this.skipRate=0,this.genreDiversity=1;return}const t=this.videoHistory.reduce((r,l)=>r+l.watchTime,0);this.avgWatchTime=t/this.videoHistory.length;const e=((c=this.settings)==null?void 0:c.minWatchTime)||3,n=this.videoHistory.filter(r=>r.watchTime<e).length;this.skipRate=this.videoHistory.length>0?n/this.videoHistory.length:0;const i=this.genreSequence.slice(-20);if(i.length>0){const r=new Set(i.filter(l=>l&&l!=="unknown"&&l!=="general")).size;this.genreDiversity=i.length>0?r/i.length:1}else this.genreDiversity=1}detectGenreFatigue(){var l;const t=((l=this.settings)==null?void 0:l.genreFatigueLimit)||15;if(this.genreSequence.length<t)return{fatigued:!1};const e=this.genreSequence.slice(-t),n={};let i="unknown",c=0;e.forEach(a=>{a&&a!=="unknown"&&a!=="general"&&(n[a]=(n[a]||0)+1,n[a]>c&&(c=n[a],i=a))});const r=t*.7;return{fatigued:c>=r&&i!=="unknown",count:c,genre:i}}updateMindlessScore(){var k,w;let t=0;const e=((k=this.settings)==null?void 0:k.scrollSpeedThreshold)||5,n=((w=this.settings)==null?void 0:w.minWatchTime)||3,i=e>0?Math.min(2,this.scrollSpeed/e):this.scrollSpeed>0?2:0,c=Math.min(30,i*15);t+=c,console.log(`RS ScoreCalc: ScrollSpeed=${this.scrollSpeed.toFixed(1)}, Threshold=${e}, ScorePart=${c.toFixed(1)}`);const r=this.skipRate*25;t+=r,console.log(`RS ScoreCalc: SkipRate=${this.skipRate.toFixed(2)}, ScorePart=${r.toFixed(1)}`);const l=this.avgWatchTime<n?20:Math.max(0,20*(1-this.avgWatchTime/(n*2))),a=Math.min(20,l);t+=a,console.log(`RS ScoreCalc: AvgWatch=${this.avgWatchTime.toFixed(1)}, MinWatch=${n}, ScorePart=${a.toFixed(1)}`);const m=(1-this.genreDiversity)*15;t+=m,console.log(`RS ScoreCalc: GenreDiversity=${this.genreDiversity.toFixed(2)}, ScorePart=${m.toFixed(1)}`);const b=(Date.now()-this.sessionStartTime)/6e4,T=Math.min(10,b/30*10);return t+=T,console.log(`RS ScoreCalc: SessionMins=${b.toFixed(1)}, ScorePart=${T.toFixed(1)}`),this.mindlessScore=Math.round(Math.max(0,Math.min(100,t))),console.log(`RS ScoreCalc: FINAL SCORE = ${this.mindlessScore}`),this.mindlessScore}getStatsAsFeatures(){const t={scrollSpeed:Number(this.scrollSpeed.toFixed(2))||0,avgWatchTime:Number(this.avgWatchTime.toFixed(1))||0,skipRate:Number(this.skipRate.toFixed(2))||0,genreDiversity:Number(this.genreDiversity.toFixed(2))||1,sessionMinutes:Math.round((Date.now()-this.sessionStartTime)/6e4)||0};for(const e in t)Number.isFinite(t[e])||(t[e]=0);return t}shouldIntervene(){var n;const t=Date.now();if((t-this.lastInterventionTime)/1e3<300)return{shouldIntervene:!1,reason:"too_soon"};this.calculateMetrics(),this.updateMindlessScore();const e=this.getStatsAsFeatures();return(n=chrome.runtime)!=null&&n.id?(chrome.runtime.sendMessage({action:"PREDICT_BEHAVIOR",features:e},i=>{if(!(u||!o||this.lastInterventionTime>t)){if(chrome.runtime.lastError){console.log("Error getting prediction:",chrome.runtime.lastError.message),this.checkHeuristicsAndTrigger(e);return}if(i!=null&&i.success&&typeof i.prediction=="number"){const c=i.prediction,r=.75;if(console.log(`RS AI Pred Received: ${c.toFixed(3)} (Thresh: ${r})`),c>r){console.log(`RS AI Trigger (Score: ${c.toFixed(2)})`),x({shouldIntervene:!0,reason:"ai_model",score:Math.round(c*100),details:e});return}else console.log("RS AI Score low. Checking heuristics.")}else console.log("Prediction failed/model not ready. Falling back.",i==null?void 0:i.error);this.checkHeuristicsAndTrigger(e)}}),{shouldIntervene:!1,reason:"checking_async"}):(console.log("Runtime not available, falling back."),this.checkHeuristics(e))}checkHeuristics(t){var i;this.updateMindlessScore();const e=((i=this.settings)==null?void 0:i.mindlessThreshold)||70,n=this.detectGenreFatigue();return console.log(`RS Heuristics CHECKING: Score=${this.mindlessScore}, Threshold=${e}, Fatigue:`,n),n.fatigued?(console.log(`RS Heuristic Trigger (Fatigue: ${n.genre} x${n.count})`),{shouldIntervene:!0,reason:"genre_fatigue",score:this.mindlessScore,details:{...t,genre:n.genre,count:n.count}}):this.mindlessScore>=e?(console.log(`RS Heuristic Trigger (Score: ${this.mindlessScore})`),{shouldIntervene:!0,reason:"mindless_score",score:this.mindlessScore,details:t}):{shouldIntervene:!1,reason:"none"}}checkHeuristicsAndTrigger(t){if((Date.now()-this.lastInterventionTime)/1e3<300){console.log("Cooldown active after async check.");return}const n=this.checkHeuristics(t);n.shouldIntervene?x(n):console.log("ReelSense: No intervention needed after checks.")}recordIntervention(){this.lastInterventionTime=Date.now()}getStats(){return this.calculateMetrics(),{mindlessScore:this.mindlessScore,scrollSpeed:this.scrollSpeed.toFixed(2),videosWatched:this.videoHistory.length,avgWatchTime:this.avgWatchTime.toFixed(1),skipRate:(this.skipRate*100).toFixed(0),genreDiversity:(this.genreDiversity*100).toFixed(0),sessionDuration:Math.round((Date.now()-this.sessionStartTime)/6e4)}}resetSession(){console.log("ReelSense: Resetting session state."),this.scrollEvents=[],this.sessionStartTime=Date.now(),this.currentVideoStartTime=null,this.currentVideoId=null,this.currentVideoGenre=null,this.mindlessScore=0}}f();
